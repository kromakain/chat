<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
</head>
<body>
    <section>
        <div align="center"> 
            <h2 id="userDisplay"></h2>
            <div id="messages">
                <!-- Aquí se mostrarán los mensajes -->
            </div>
            <div>
                <label for="mensaje">mensaje </label>
                <textarea  id="mensaje"></textarea>
            </div>
            <label for="recipient">Selecciona un destinatario:</label>
            <select id="recipient">
             
            </select>
            <button type="button" id="btnEnviar">Enviar</button>
            <button id="signOutBtn">Desconectar</button>
        </div>
    </section>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js';
        import { getDatabase, ref, push, onChildAdded, query, equalTo } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js';

        const firebaseConfig = {
    apiKey: "AIzaSyAOnRHRND19HSaN19cUlez3AepxYOhszdM",
    authDomain: "porientadainternet.firebaseapp.com",
    projectId: "porientadainternet",
    storageBucket: "porientadainternet.appspot.com",
    messagingSenderId: "112181805077",
    appId: "1:112181805077:web:a8a3ec9a7d190c42448e1c"
};
     // Inicializa Firebase
     const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Muestra el usuario que inició sesión
        const userDisplay = document.getElementById('userDisplay');
        const recipientSelect = document.getElementById('recipient');
        const messagesContainer = document.getElementById('messages');

        // Espera a que la autenticación se complete antes de actualizar userDisplay
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userDisplay.textContent = `${user.email}`;
                loadMessages(user.email); // Cargar mensajes para el usuario actual
            }
        });

        // Obtén la lista de usuarios de Firebase y agrégala al combobox
        const usersRef = ref(db, 'usuarios');
        onChildAdded(usersRef, (snapshot) => {
            const user = snapshot.val();
            const currentUser = auth.currentUser;

            // Filtrar el usuario actual
            if (currentUser && user.email !== currentUser.email) {
                const option = document.createElement('option');
                option.value = user.email;
                option.textContent = user.email;
                recipientSelect.appendChild(option);
            }
        });

        // Función para cargar mensajes
        function loadMessages(recipient) {
            const chatRef = ref(db, 'chat'); // Usamos la referencia general
            onChildAdded(chatRef, (snapshot) => {
                const message = snapshot.val();
                const user = auth.currentUser;
                
                // Filtrar mensajes para mostrar solo los mensajes del destinatario actual
                if (user && message.destinatario === user.email) {
                    const messageDiv = document.createElement('div');
                    messageDiv.textContent = `${message.remitente}: ${message.mensaje}`;
                    messagesContainer.appendChild(messageDiv);
                }
            });
        }

        // Envía un mensaje a la base de datos
        var txtMensaje = document.getElementById("mensaje");
        var btnEnviar = document.getElementById("btnEnviar");

        btnEnviar.addEventListener("click", function(){
            const user = auth.currentUser;
            const username = user.email;
            const mensaje = txtMensaje.value;
            const recipient = recipientSelect.value;

            const chatRef = ref(db, 'chat');
            push(chatRef, {
                remitente: username,
                mensaje: mensaje,
                destinatario: recipient
            });

            txtMensaje.value = '';
        });

        // Desconectar al usuario
        const signOutBtn = document.getElementById('signOutBtn');

        signOutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                // Redirige al usuario a la página de inicio de sesión después de desconectar
                window.location.href = "index.html"; // Cambia esto por la URL de tu página de inicio de sesión
            }).catch((error) => {
                console.error("Error al desconectar:", error);
            });
        });
    </script>
</body>
</html>